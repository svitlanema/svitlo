<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Графік відсутності світла</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #e0f7fa, #f8f8f8);
  color: #333;
  text-align: center;
  margin: 0;
  padding: 0;
}
.layout {
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: 40px;
  flex-wrap: wrap;
  margin-top: 20px;
}
#controls {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(12px);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  text-align: left;
  max-width: 360px;
}
label {
  display: block;
  margin: 6px 0 2px;
  font-weight: 600;
}
input, textarea {
  width: 320px;
  padding: 8px;
  font-size: 16px;
  margin-bottom: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
  transition: border-color 0.3s;
  background: rgba(255,255,255,0.85);
}
input:focus, textarea:focus {
  border-color: #2468bd;
  outline: none;
}
textarea {
  height: 140px;
  resize: vertical;
  white-space: pre;
}
button {
  background: #2468bd;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s, transform 0.06s;
  margin: 5px;
  padding: 8px 12px;
  font-size: 14px;
}
button:hover { background: #4c88d1; }
button:active { transform: translateY(1px); }
.small-btn {
  background: #90caf9;
  color: #fff;
  font-size: 12px;
  padding: 4px 8px;
  margin-left: 10px;
}
.small-btn:hover { background: #64b5f6; }
.inline-header {
  display: flex;
  align-items: center;
  margin-top: 6px;
  margin-bottom: 6px;
}
.inline-header label { margin: 0; }
.bottom-buttons {
  margin-top: 12px;
  text-align: right;
}
.circle-wrapper {
  position: relative;
  width: 500px;
  height: 500px;
}
canvas {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
  background-image: url('clock_clear.png');
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}
.overlay {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 2;
  width: 500px;
  height: 500px;
  pointer-events: none;
}
#dateOverlay {
  position: absolute;
  top: 190px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  font-size: 20px;
  color: #333;
  background: rgba(255,255,255,0.75);
  padding: 6px 12px;
  border-radius: 6px;
  z-index: 3;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
#dateOverlay .queue-title { font-weight: 700; }
#dateOverlay .date-value { font-weight: 600; }
#dateOverlay .extra-text { font-weight: 500; font-size: 18px; color: #444; }
#summary {
  margin: 20px auto;
  font-size: 16px;
  max-width: 900px;
}
.error {
  background-color: #ffdddd;
}
</style>
</head>
<body>
<h2>Графік відсутності світла</h2>

<div class="layout">
  <div id="controls">
    <label for="inputQueue">Черга відключення:</label>
    <input type="text" id="inputQueue" placeholder="Напр. 5.2" inputmode="decimal" pattern="[0-9.]*">

    <label for="inputDate">Введіть дату:</label>
    <input type="date" id="inputDate">

    <label for="inputExtra">Світла не буде:</label>
    <input type="text" id="inputExtra" placeholder="Скільки загально?">

    <div class="inline-header">
      <label for="inputTimes">Введіть періоди відключення світла:</label>
      <button id="btnExample" class="small-btn">?</button>
    </div>

    <textarea id="inputTimes" placeholder="Кожна строка — інтервал, напр.:
06:00-10:00
12:00-16:00"></textarea>

    <div class="bottom-buttons">
      <button id="btnClear">Очистити</button>
      <button id="btnBuild">Створити коло</button>
    </div>
  </div>

  <div class="circle-wrapper">
    <div id="dateOverlay">
      <span class="queue-title" id="queueTitle"></span>
      <span class="date-value" id="dateValue"></span>
      <span class="extra-text" id="extraText"></span>
    </div>
    <canvas id="circleCanvas" width="500" height="500"></canvas>
    <img src="clock_bg.png" alt="Цифри" class="overlay">
  </div>
</div>

<div id="summary">Світла немає: 0 год. 0 хв. — інтервалів: 0</div>

<script>
// Canvas setup
const canvas = document.getElementById('circleCanvas');
const ctx = canvas.getContext('2d');
const centerX = canvas.width / 2;
const centerY = canvas.height / 2;
const radiusOuter = 239;
const sectorColors = ['#a54141', '#b96262']; // чергування по годинах

// Utils
function timeToMinutes(str) {
  const parts = str.split(':');
  if (parts.length !== 2) return NaN;
  const h = Number(parts[0]), m = Number(parts[1]);
  if (!Number.isInteger(h) || !Number.isInteger(m)) return NaN;
  if (h < 0 || h > 23 || m < 0 || m > 59) return NaN;
  return h * 60 + m;
}
function minutesToAngle(min) {
  const m = ((min % 1440) + 1440) % 1440; // нормалізація
  const offset = -(1 / 24) * 2 * Math.PI; // юстування під фон
  return (m / 1440) * 2 * Math.PI - Math.PI / 2 + offset;
}
function hexToRGBA(hex, alpha) {
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function drawSector(startMin, endMin, color) {
  const startAngle = minutesToAngle(startMin);
  const endAngle = minutesToAngle(endMin);
  ctx.beginPath();
  ctx.moveTo(centerX, centerY);
  ctx.arc(centerX, centerY, radiusOuter, startAngle, endAngle, false);
  ctx.closePath();
  ctx.fillStyle = hexToRGBA(color, 1.0);
  ctx.fill();
}
function drawCenterText(queueName, intervals, totalMinutes) {
  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  const lines = [
    (queueName ? `Черга ${queueName}` : 'Черга'),
    'Відсутнє світло',
    ...intervals,
    `(${hours} год. ${minutes} хв.)`
  ];
  ctx.font = '16px Inter, sans-serif';
  ctx.fillStyle = '#fff';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.shadowColor = 'rgba(0,0,0,0.6)';
  ctx.shadowBlur = 4;
  const lineHeight = 20;
  const startY = centerY - (lines.length / 2) * lineHeight;
  lines.forEach((line, i) => ctx.fillText(line, centerX, startY + i * lineHeight));
  ctx.shadowBlur = 0;
}

// Validation
function validateIntervals() {
  const textarea = document.getElementById('inputTimes');
  const lines = textarea.value.split('\n');
  let valid = true;
  const regex = /^([01]\d|2[0-3]):[0-5]\d-([01]\d|2[0-3]):[0-5]\d$/;
  for (let raw of lines) {
    const t = raw.trim();
    if (!t) continue;
    if (!regex.test(t)) { valid = false; break; }
    const [start, end] = t.split('-');
    const startMin = timeToMinutes(start);
    const endMin = timeToMinutes(end);
    if (Number.isNaN(startMin) || Number.isNaN(endMin)) { valid = false; break; }
    if (endMin <= startMin) { valid = false; break; }
  }
  textarea.classList.toggle('error', !valid);
  return valid;
}

// Helpers
function formatDateDDMMYYYY(dateRaw) {
  const d = dateRaw ? new Date(dateRaw) : new Date();
  const day = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year = d.getFullYear();
  return `${day}.${month}.${year}`;
}

// Build
function build() {
  if (!validateIntervals()) {
    document.getElementById('summary').textContent = 'Помилка: невірний формат інтервалів';
    return;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const input = document.getElementById('inputTimes').value;
  const queueName = document.getElementById('inputQueue').value.trim();
  const dateRaw = document.getElementById('inputDate').value;
  const extraValue = document.getElementById('inputExtra').value.trim();

  // overlay: назва черги (з префіксом), дата і додатковий текст
  document.getElementById('queueTitle').textContent = queueName ? `Черга ${queueName}` : 'Черга';
  document.getElementById('dateValue').textContent = formatDateDDMMYYYY(dateRaw);
  document.getElementById('extraText').textContent = extraValue;

  const intervals = input.split('\n').map(s => s.trim()).filter(Boolean);
  let totalMinutes = 0;

  intervals.forEach((interval) => {
    const [start, end] = interval.split('-');
    const startMin = timeToMinutes(start);
    const endMin = timeToMinutes(end);
    if (Number.isNaN(startMin) || Number.isNaN(endMin)) return;
    if (endMin <= startMin) return;

    // Чергуємо по кожній годині всередині інтервалу
    let min = startMin;
    while (min < endMin) {
      const nextHourBoundary = Math.floor(min / 60) * 60 + 60; // кінець поточної години
      const nextMin = Math.min(nextHourBoundary, endMin);
      const color = sectorColors[Math.floor(min / 60) % sectorColors.length];
      drawSector(min, nextMin, color);
      min = nextMin;
    }
    totalMinutes += endMin - startMin;
  });

  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;
  document.getElementById('summary').textContent =
    `Світла немає: ${hours} год. ${minutes} хв. — інтервалів: ${intervals.length}`;

  drawCenterText(queueName, intervals, totalMinutes);
}

// Example ("?")
function example() {
  document.getElementById('inputQueue').value = '5.2';
  document.getElementById('inputDate').value = '2025-11-22';
  document.getElementById('inputExtra').value = 'Світла немає:';
  document.getElementById('inputTimes').value =
    '00:00-02:30\n04:00-06:00\n10:00-12:00\n14:00-18:00\n20:30-22:30';
  build();
}

// Clear
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  document.getElementById('inputQueue').value = '';
  document.getElementById('inputDate').value = '';
  document.getElementById('inputExtra').value = '';
  const ta = document.getElementById('inputTimes');
  ta.value = '';
  ta.classList.remove('error');
  document.getElementById('queueTitle').textContent = '';
  document.getElementById('dateValue').textContent = '';
  document.getElementById('extraText').textContent = '';
  document.getElementById('summary').textContent = 'Світла немає: 0 год. 0 хв. — інтервалів: 0';
}

// Bind buttons
document.getElementById('btnExample').addEventListener('click', example);
document.getElementById('btnBuild').addEventListener('click', build);
document.getElementById('btnClear').addEventListener('click', clearCanvas);

// Input guards
// 1) Поле "Черга відключення": автозаміна коми на крапку + тільки цифри та крапки
document.getElementById('inputQueue').addEventListener('input', (e) => {
  let value = e.target.value.replace(/,/g, '.');
  value = value.replace(/[^0-9.]/g, '');
  if (value !== e.target.value) e.target.value = value;
});
// 2) Тільки цифри, двокрапка, дефіс і переноси рядків для періодів
document.getElementById('inputTimes').addEventListener('input', (e) => {
  const cleaned = e.target.value.replace(/[^0-9:\-\n]/g, '');
  if (cleaned !== e.target.value) e.target.value = cleaned;
  validateIntervals();
});
</script>
</body>
</html>